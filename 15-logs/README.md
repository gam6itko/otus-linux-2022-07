# –°–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ 

## –ó–∞–¥–∞–Ω–∏–µ

- –≤ –≤–∞–≥—Ä–∞–Ω—Ç–µ –ø–æ–¥–Ω–∏–º–∞–µ–º 2 –º–∞—à–∏–Ω—ã web –∏ log
- –Ω–∞ web –ø–æ–¥–Ω–∏–º–∞–µ–º nginx
- –Ω–∞ log –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ª–æ–≥ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ª—é–±–æ–π —Å–∏—Å—Ç–µ–º–µ –Ω–∞ –≤—ã–±–æ—Ä
  - journald;
  - rsyslog;
  - elk.
- –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É–¥–∏—Ç, —Å–ª–µ–¥—è—â–∏–π –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ñ–∏–≥–æ–≤ nginx

–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏ —Å web –¥–æ–ª–∂–Ω—ã —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –∏ –ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ.
–í—Å–µ –ª–æ–≥–∏ —Å nginx –¥–æ–ª–∂–Ω—ã —É—Ö–æ–¥–∏—Ç—å –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–ª–æ–∫–∞–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ).
–õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞ –¥–æ–ª–∂–Ω—ã —Ç–∞–∫–∂–µ —É—Ö–æ–¥–∏—Ç—å –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É.
–§–æ—Ä–º–∞—Ç —Å–¥–∞—á–∏ –î–ó - vagrant + ansible

–ó–∞–¥–∞–Ω–∏—è —Å–æ –∑–≤—ë–∑–¥–æ—á–∫–æ–π:
- —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –µ—â–µ –º–∞—à–∏–Ω—É elk —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å 2 —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –ª–æ–≥ —Å–∏—Å—Ç–µ–º—ã elk –∏ –∫–∞–∫—É—é –ª–∏–±–æ –µ—â–µ. 
    –í elk –¥–æ–ª–∂–Ω—ã —É—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ –Ω–∂–∏–Ω–∫—Å–∞, –≤–æ –≤—Ç–æ—Ä—É—é —Å–∏—Å—Ç–µ–º—É –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ.


## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- https://habr.com/ru/post/538840/
- https://www.elastic.co/guide/en/elasticsearch/reference/8.5/docker.html
- https://www.elastic.co/guide/en/elasticsearch/reference/8.5/cat.html
- https://www.elastic.co/guide/en/beats/filebeat/8.5/filebeat-module-nginx.html
- https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html
- https://xakep.ru/2011/03/30/54897/
- https://habr.com/ru/company/selectel/blog/267833/
- [–¢–∞–±–ª–∏—Ü–∞ –Ω–æ–º–µ—Ä–æ–≤ syscall](https://filippo.io/linux-syscall-table/)


## –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

–° –ø–æ–º–æ—â—å—é ansible –º—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞–∫–µ—Ç—ã:

- web
  - auditd
  - nginx
- log
  - docker

–û–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `vagrant up` –ª–∏–±–æ `vagrant provision`

### ELK

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ELK –±—É–¥–µ—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ, —Ç.–∫. –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§ –ø–æ—Å–ª–µ 24.02.2022 —ç—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ù–æ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–æ–∫–µ—Ä. –ë—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–º.
–ù–∞ –º–∞—à–∏–Ω–µ log –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4GB –û–ó–£ —á—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ –±–µ–∑ —Ç–æ—Ä–º–æ–∑–æ–≤. –¢–∞–∫ —Å–æ–≤–µ—Ç—É—é—Ç –Ω–∞ —Å–∞–π—Ç–µ ES.

–ß—Ç–æ–±—ã –∑–∞–∫–æ–≤–æ –Ω–µ —Å–∫–∞—á–∏–≤–∞—Ç—å –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –í–ú —Å —Å–µ—Ç–∏ (~3GB) –æ–±—Ä–∞–∑—ã docker. –ü—Ä–∏–º–µ–Ω–∏–º —Ö–∞–∫: —Å–∫–∞—á–∞–µ–º –æ–±—Ä–∞–∑—ã –Ω–∞ host-machine –∏ –¥–∞–ª–µ–µ –±—É–¥–µ—Ç –∏—Ö –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ guest-machine.
–ù–∞ —Ö–æ—Å—Ç–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É `./docker-warmup.sh`.

–ù–∞ guest –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
```shell
docker import /vagrant/docker-image/elasticsearch.image
docker import /vagrant/docker-image/kibana.image
```

logstash –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç–º, —Ç.–∫. –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å filebeat

#### es

–ü–æ—Å–ª—É —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ docker-compose –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ ES.

–î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑ host-machine
```shell
$ curl -X GET "192.168.56.24:9200/_cat/master?help&pretty"
{
  "error" : {
    "root_cause" : [
      {
        "type" : "security_exception",
        "reason" : "missing authentication credentials for REST request [/_cat/master?help&pretty]",
        "header" : {
          "WWW-Authenticate" : [
            "Basic realm=\"security\" charset=\"UTF-8\"",
            "ApiKey"
          ]
        }
      }
    ],
    "type" : "security_exception",
    "reason" : "missing authentication credentials for REST request [/_cat/master?help&pretty]",
    "header" : {
      "WWW-Authenticate" : [
        "Basic realm=\"security\" charset=\"UTF-8\"",
        "ApiKey"
      ]
    }
  },
  "status" : 401
}
```
–ü–æ—Ö–æ–∂–µ —á—Ç–æ-—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –≥–ª–∞–¥–∫–æ. –ò –Ω–∞–º –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏. –î–µ–ª–∞–µ–º —ç—Ç–æ –ø—É—Ç—ë–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ env `xpack.security.enabled=false` –≤ docker.


–î–µ–ª–∞–µ–º —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å –µ—â–µ —Ä–∞–∑
```shell
$ curl -X GET "localhost:9200/_cat/master?v=true&pretty"
id                     host       ip         node
Gx4Z61Q8SleZYj_mD6Az6A 172.18.0.3 172.18.0.3 es-node
```

–¢–∞–∫ –∂–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–π—Ç–∏ —á–µ—Ä–µ–∑ web-–±—Ä–∞—É–∑–µ—Ä –Ω–∞ –∞–¥—Ä–µ—Å http://192.168.56.24:9200/ –∏ —É–≤–µ–¥–µ—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç es-server
```json
{
  "name" : "es-node",
  "cluster_name" : "es-docker-cluster",
  "cluster_uuid" : "mP9w2cycSIipYv0iM3Jv-w",
  "version" : {
    "number" : "8.5.3",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "4ed5ee9afac63de92ec98f404ccbed7d3ba9584e",
    "build_date" : "2022-12-05T18:22:22.226119656Z",
    "build_snapshot" : false,
    "lucene_version" : "9.4.2",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
```


#### kibana

Web ui –∫–∏–±–∞–Ω—ã —Ä–∞—Å–ø–æ–ª–æ–≥–∞–µ—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É http://192.168.56.24:5601/

–í —ç—Ç–æ–º web ui –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º –∞–¥—Ä–µ—Å—Å —Å–µ—Ä–≤–µ—Ä–∞ http://192.168.56.24:9200 –∏ –≤–≤–æ–¥–∏–º –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö kibana (—É –º–µ–Ω—è –æ–Ω –±—ã–ª  504 156).

–í kibana –≤–æ—à–ª–∏, –æ—Å—Ç–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ –Ω–µ–π –¥–∞–Ω–Ω—ã–µ.


### Nginx filebeat –¥–ª—è –æ—Ç–ø—Ä–∞–≤—Å–∫–∏ –ª–æ–≥–æ–≤ –≤ ELK

–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ nginx –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É http://192.168.56.23:80/

–° –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥ `cat /var/log/nginx/access.log` –∏ `cat /var/log/nginx/error.log` –º—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–∞—Ç—Ä–∏–≤–∞—Ç—å –ª–æ–≥–∏ –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç nginx

–ù–∞–º –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å filebeat.

–¢.–∫. –∏–∑ –†–§ –Ω–µ–ª—å–∑—è —Å–∫–∞—á–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —ç—Ç–∏ —Ñ–∞–π–ª—ã, —Ç–æ —è –ø–æ–ø—Ä–æ—Å–∏–ª –æ–¥–Ω–æ–≥–æ –º–æ–µ–≥–æ –¥—Ä—É–≥–∞ –∏–∑ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω—ã —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –ø–æ —Å—Å—ã–ª–∫–µ 
https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.5.3-amd64.deb, –∫–æ—Ç–æ—Ä—ã–π —è –ø–æ–ª–æ–∂–∏–ª –≤ –ø–∞–ø–∫—É dl.

–í–Ω—É—Ç—Ä–∏ –í–ú web —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `sudo dpkg -i /vagrant/dl/filebeat-8.5.3-amd64.deb`.

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `/etc/filebeat.yml`. –ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –ª–æ–≥–æ–≤ –≤ elasticsearch.

–í–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å nginx
```shell
filebeat modules enable nginx
systemctl start filebeat
```

–í —Ñ–∞–π–ª–µ `/etc/filebeat/modules.d/nginx.yml` –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ –ª–æ–≥–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º filebeat.service.

–ï—Å–ª–∏ —É –Ω–∞—Å –≤—Å—ë –ø–æ–ª—É—á–∏–ª–∏–ª–æ—Å—å, —Ç–æ –∏–¥—ë–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É http://192.168.56.24:5601/app/logs/stream –∏ —Å–º–æ—Ç—Ä–∏–º –µ—Å—Ç—å –ª–∏ —Ç–∞–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤.
–ß—Ç–æ–±—ã –æ–Ω–∏ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–¥–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É http://192.168.56.23:80/

![kibana nginx logs](./img/01_kibana_logs.png)

#### auditd

–ß—Ç–æ–±—ã —Å–æ–±–∏—Ä–∞—Ç—å –ª–æ–≥–∏ auditd –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å `filebeat modules enable auditd` –∏ –≤ —Ñ–∞–π–ª–µ `/etc/filebeat/modules.d/auditd.yml` –≤–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å.

–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å auditd —á—Ç–æ–±—ã –æ–Ω —Å–æ–±–∏—Ä–∞–ª –ª–æ–≥–∏—Ä–æ–≤–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ nginx.
–°–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª `/etc/audit/rules.d/my.rules` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
```
-w /etc/audit/auditd.conf -p wa
-w /etc/audit/audit.rules -p wa

-w /etc/nginx/nginx.conf -p wa
-w /etc/nginx/conf.d/ -p wa
-w /etc/nginx/sites-enabled/ -p wa
```

–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–ª—É–∂–±—É `systemctl restart auditd`. 
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤ —Ñ–∞–π–ª–µ `/etc/audit/audit.rules` –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Ñ–∞–π–ª–∞ my.rules

–î–æ–±–∞–≤–∏–º –≤ —Ñ–∞–π–ª `/etc/nginx/nginx.conf` —Å—Ç—Ä–æ–∫—É `charset utf-8;` –≤ —Ä–∞–∑–¥–µ–ª http –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `aureport -s` —Ç–æ –º—ã –≤–∏–¥–∏–º —á—Ç–æ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ 4 —Å—Ç—Ä–æ—á–∫–∏.
```
1489. 01/04/23 11:12:18 82 4533 vi 1000 462
1490. 01/04/23 11:12:18 257 4533 vi 1000 463
1491. 01/04/23 11:12:18 91 4533 vi 1000 464
1492. 01/04/23 11:12:18 188 4533 vi 1000 465
```
–ù–æ–º–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–ª–æ–Ω–∫–µ (462...465). 
–î–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π `ausearch -a 462` (–ø—Ä–∞–≤–¥–∞, –ø–æ–Ω—è—Ç–Ω–µ–µ –Ω–µ —Å—Ç–∞–Ω–µ—Ç —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ)

–¢–∞–∫ –∂–µ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–Ω—ã –∏ –≤ —Ñ–∞–π–ª–µ /var/log/audit/audit.log.

#### auditd to ELK

–í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –≤—ã—à–µ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –∞—É–¥–∏—Ç–∞ –≤—Å—ë –∂–µ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∏ –Ω–∞–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ö –≤ ES.

–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ /etc/filebeat/modules.d/auditd.yml –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ–± –∞—É–¥–∏—Ç–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞.
```yaml
- module: auditd
  log:
    enabled: true
```
–ú–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É filebeat.

–ó–∞—Ö–æ–¥–∏–º –≤ kibana –∏ –≤–∏–¥–∏–º —á—Ç–æ ES –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–æ–≥–∏ –∞—É–¥–∏—Ç–∞ –æ—Ç filebeat ü•≥

![kibana auditd logs](./img/02_kibana_auditd.png)



