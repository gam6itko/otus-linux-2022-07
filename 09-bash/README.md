# Bash


## Задание

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:

- Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта.
- Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта.
- Ошибки веб-сервера/приложения c момента последнего запуска.
- Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.
- Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.
  В письме должен быть прописан обрабатываемый временной диапазон.


## полезные сылки

- https://habr.com/ru/company/southbridge/blog/255845/
- https://habr.com/ru/company/ruvds/blog/512868/
- https://tecadmin.net/ways-to-send-email-from-linux-command-line/
- https://techrocks.ru/2019/01/21/bash-if-statements-tips/
- https://losst.ru/komanda-cut-linux
- https://www.baeldung.com/linux/substitute-variables-text-file
- https://docs.nginx.com/nginx/admin-guide/monitoring/logging/

## Выполнение

Для работы нам нужен web-сервер. Будем использовать nginx. Устанавливаем и включаем.
```shell
dnf install -y nginx
systemctl enable nginx
systemctl start nginx
```

Из браузера на нашей host-machine зайдём на адрес http://192.168.56.10/ чтобы убедиться что web-server работает.

Для работы сервиса будем использовать systemd и его таймер. Создадим файлы `ws_status.service`, `ws_status.timer`, `ws_status.sh`.

Вся логика будет в скрипте `ws_status.sh`.

Для того чтобы запускался лишь один процесс мы будем использовать файл `/var/lib/ws_status/lock`, если он есть значит процесс ws_status.sh уже запущен.
Возможно, это не самый лучше способ синхронизировать доступ к критической области, но для ДЗ, этого хватит.

Для обмена информацией между запусками мы будем использовать файл `/var/lib/ws_status/last_run.env`.
В этот файл скрипт будет писать итоговую информацио о количестве обработанных строк и прочее.

При каждом запуске будем смотреть файл логов в папке `/var/log/nginx`. 
В файле `/var/lib/ws_status/last_run.env` будем хранить последнее обработанное количество строчек.
Обработака новыхстрочек будет вестись с последнего записанного в этот файл.

Чтобы было легче доставать из логов nginx нужную информацию мы добавим конфигураций логов и будем писать их в разные файлы.


### Список IP адресов

`awk "NR >= $ACCESS_LINE && NR <= $LAST_ACCESS_LINE" /var/log/nginx/access.log` - выбираем новые строчки.
`cut -f 1 -d ' '` - вырезаем IP адрес
`sort` - сортируем чтобы uniq правильно посчитал уникальные строки по одному разу
`uniq -c` - групируем и показываем количество уникальных IP
`sort -d -r` - сортируем от наибольшего количества повторений к наименьшему


### Список запрашиваемых URL

Команда похожая на предыдущую, только меняем аргумент -d на 3

### Список всех кодов HTTP ответа

Команда похожая на предыдущую, только меняем аргумент -d на 5

### Ошибки веб-сервера/приложения c момента последнего запуска.

Тут просто берём всё ошибки с последнего запуска

### отправка письма

В файле `/etc/sysconfig/ws_status.conf` нужно указать на какую почту будет уходить письмо


## Првоерка

Перед первым запуском нужно изменить EMAIL в файле `etc/sysconfig/ws_status.conf`.
Так же лучше изменить значение `OnUnitActiveSec` в файле  `etc/systemd/system/ws_status.timer` чтобы не ждать срабатывания таймера целые сутки. 


## Полезные команды

`systemctl status ws_status.timer` - проверка статуса таймера
`/opt/ws_status.sh` - запустить главный скрипт вручную
`systemctl start ws_status.service` - запустить главный вкрипт вручную, но как сервис
`/vagrant/opt/fill_log.sh` - заполнить логи nginx
`/tmp/last-email.txt` - вывести последнее отправленное письмо
